---
- name: Install Dnsmasq package
  package:
    name: dnsmasq
    state: present

- name: Configure Debian defaults
  when: ansible_os_family == "Debian"
  lineinfile:
    dest: /etc/default/dnsmasq
    state: "{% if item.value == '' -%} absent {%- else -%} present {%- endif %}"
    regexp: "^\\s*{{ item.key | upper }}="
    line: "{{ item.key | upper }}={{ item.value }}"
    insertafter: "^#\\s*{{ item.key | upper }}"
  with_dict:
    enabled: 1
    ignore_resolvconf: "yes"
    config_dir: ""
  notify: Restart Dnsmasq

- name: Configure daemon settings
  include_tasks: >-
    {{ (option.value is sequence and option.value is not string)
    | ternary('sequence', 'scalar') }}.yml
  with_dict: "{{ dnsmasq_settings }}"
  loop_control:
    loop_var: option
  notify: Restart Dnsmasq
